<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload Document â€” Sign In</title>
    <style>
      body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f7fafc; color:#0f172a; }
      .card { max-width:640px; margin:48px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 6px 20px rgba(2,6,23,0.08); }
      label { display:block; font-size:13px; margin-top:12px; color:#334155; }
      input { width:100%; padding:10px 12px; margin-top:6px; border:1px solid #e2e8f0; border-radius:6px; }
      button { margin-top:14px; padding:10px 14px; background:#2563eb; color:white; border:0; border-radius:6px; cursor:pointer; }
      pre { background:#0b1220; color:#e6eef8; padding:12px; border-radius:6px; overflow:auto; }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Organization Sign In (Upload Document UI)</h2>
      <p style="color:#475569">Enter Supabase connection and credentials to sign in and print the organization id.</p>

      <label>Supabase URL</label>
      <label>Supabase Anon Key</label>
        <div id="supabase-config-area">
          <p style="margin:0 0 8px 0;color:#475569">Supabase configuration is loaded from local `.env`.</p>
          <div id="supabase-config-status" style="font-size:13px;color:#334155">(loading config...)</div>
        </div>

      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" />

      <label>Password</label>
      <input id="password" type="password" placeholder="password" />

      <div style="display:flex;gap:8px;align-items:center">
        <button id="signin">Sign in</button>
        <button id="clear" style="background:#475569">Clear</button>
      </div>

      <div id="status" style="margin-top:16px"></div>
      <div id="home" style="display:none; margin-top:18px">
        <h3 id="greeting"></h3>
        <div style="margin-top:12px">
          <label>Upload Document</label>
          <input id="uploadFile" type="file" />
          <div style="margin-top:8px">
            <button id="uploadBtn">Upload</button>
            <span id="uploadStatus" style="margin-left:8px;color:#334155"></span>
          </div>
        </div>
      </div>
    </div>

    <script src="./env-config.js"></script>
    <script>
      const el = id => document.getElementById(id)
      const status = el('status')

      // Display config status from generated env-config
      try {
        const statusEl = el('supabase-config-status')
        if (window.__UPLOAD_DOC_ENV && window.__UPLOAD_DOC_ENV.SUPABASE_URL && window.__UPLOAD_DOC_ENV.SUPABASE_KEY) {
          statusEl.textContent = 'Using configuration from .env (loaded). Supabase URL and Key hidden.'
        } else {
          statusEl.textContent = 'No configuration found. Please generate env-config.js or provide SUPABASE_URL and SUPABASE_KEY.'
        }
      } catch (e) {
        // ignore
      }

      el('signin').addEventListener('click', async () => {
        status.textContent = ''
        // update status area (avoid using undefined variables)
        status.textContent = '(working...)'

        const email = el('email').value.trim()
        const password = el('password').value

        if (!email || !password) {
          status.textContent = 'Please provide Email and Password.'
          return
        }

        try {
          status.textContent = 'Signing in (server)...'
          console.log('[upload_document frontend] Sending /api/signin request', { email })
          const resp = await fetch('/api/signin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          })

          let data = null
          try {
            data = await resp.json()
          } catch (e) {
            console.warn('[upload_document frontend] /api/signin returned non-JSON response', e)
          }

          console.log('[upload_document frontend] /api/signin response', { status: resp.status, data })

          if (!resp.ok) {
            status.textContent = (data && data.error) ? data.error : `Sign-in failed (status ${resp.status})`
            return
          }

          // Move to home view; server still logs org_id to terminal
          status.textContent = 'Signed in'
          sessionStorage.setItem('upload_user', JSON.stringify(data.user || {}))
          sessionStorage.setItem('upload_org', data.org_id || '')
          showHome(data.user)
        } catch (err) {
          console.error('[upload_document frontend] Unexpected error in sign-in flow', err)
          status.textContent = 'Network or client error. See console for details.'
        }
      })

      el('clear').addEventListener('click', () => {
        el('email').value = ''
        el('password').value = ''
        el('status').textContent = ''
      })

      function showHome(user) {
        // hide login inputs
        document.querySelectorAll('label, #email, #password, #signin, #clear, #supabase-config-area').forEach(e => { if (e) e.style.display = 'none' })
        // show home
        const home = el('home')
        const greet = el('greeting')
        greet.textContent = 'Hi ' + (user?.email || user?.id || 'User')
        home.style.display = 'block'

        // wire upload
        el('uploadBtn').addEventListener('click', async () => {
          const fileInput = el('uploadFile')
          const uploadStatus = el('uploadStatus')
          uploadStatus.textContent = ''
          if (!fileInput.files || fileInput.files.length === 0) {
            uploadStatus.textContent = 'Please choose a file.'
            return
          }
          const file = fileInput.files[0]
          const form = new FormData()
          form.append('file', file, file.name)
          form.append('description', 'Uploaded from UI')
          // attach user and org IDs so the server can persist metadata
          try {
            const user = JSON.parse(sessionStorage.getItem('upload_user') || '{}')
            const org = sessionStorage.getItem('upload_org') || ''
            if (user && user.id) form.append('user_id', user.id)
            if (org) form.append('org_id', org)
            console.log('[upload_document frontend] attaching user/org to upload', { user_id: user?.id, org_id: org })
          } catch (e) {
            console.warn('[upload_document frontend] failed to attach user/org to upload', e)
          }

          uploadStatus.textContent = 'Uploading...'
          try {
            const resp = await fetch('/api/organizations/me/documents', {
              method: 'POST',
              body: form,
              credentials: 'include'
            })
            let data = null
            try { data = await resp.json() } catch (e) { console.warn('Non-JSON upload response', e) }
            console.log('[upload_document frontend] upload response', { status: resp.status, data })
            if (!resp.ok) {
              uploadStatus.textContent = (data && data.error) ? data.error : `Upload failed (status ${resp.status})`
            } else {
              uploadStatus.textContent = 'Uploaded: ' + (data.document_id || 'ok')
            }
          } catch (e) {
            console.error(e)
            uploadStatus.textContent = 'Upload error'
          }
        })
      }
    </script>
  </body>
</html>
